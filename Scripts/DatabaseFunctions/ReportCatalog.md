USE [WaDE_Oct2014]
GO

/****** Object:  UserDefinedFunction [wade_r].[ReportCatalog]    Script Date: 8/15/2016 11:22:32 AM ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO


CREATE FUNCTION [wade_r].[ReportCatalog](@orgid varchar(10), @loctype varchar(max), @loctxt varchar(max))
  RETURNS xml

BEGIN
--BEGIN FUNCTION

DECLARE @tmp XML='';

IF @loctype='HUC'

BEGIN
--BEGIN HUC

WITH XMLNAMESPACES('ReplaceMe' AS WC)

SELECT @tmp=(SELECT REPORT_ID AS 'WC:ReportIdentifier',
	REPORTING_DATE AS 'WC:ReportingDate',
	REPORTING_YEAR AS 'WC:ReportingYear',
	REPORT_NAME AS 'WC:ReportName',
	REPORT_LINK AS 'WC:ReportLink',
	YEAR_TYPE AS 'WC:YearType',
	(SELECT WADE_R.LocationCatalog(@orgid, REPORT_ID, @loctype, @loctxt))
	
	FROM 
	
	WADE.REPORT A WHERE ORGANIZATION_ID=@orgid AND EXISTS (SELECT B.ORGANIZATION_ID, B.REPORT_ID 
	FROM WADE_R.CATALOG_SUMMARY B WHERE A.ORGANIZATION_ID=B.ORGANIZATION_ID AND A.REPORT_ID=B.REPORT_ID 
	AND B.HUC=@loctxt) FOR XML PATH ('WC:Report'));
	
END
--END HUC

IF @loctype='COUNTY'
BEGIN
--BEGIN COUNTY

WITH XMLNAMESPACES('ReplaceMe' AS WC)

SELECT @tmp=(SELECT REPORT_ID AS 'WC:ReportIdentifier',
	REPORTING_DATE AS 'WC:ReportingDate',
	REPORTING_YEAR AS 'WC:ReportingYear',
	REPORT_NAME AS 'WC:ReportName',
	REPORT_LINK AS 'WC:ReportLink',
	YEAR_TYPE AS 'WC:YearType',
	(SELECT WADE_R.LocationCatalog(@orgid, REPORT_ID, @loctype, @loctxt))
	
	FROM 
	
	WADE.REPORT A WHERE ORGANIZATION_ID=@orgid and EXISTS (SELECT B.ORGANIZATION_ID, B.REPORT_ID 
	FROM WADE_R.CATALOG_SUMMARY B WHERE A.ORGANIZATION_ID=B.ORGANIZATION_ID AND A.REPORT_ID=B.REPORT_ID 
	AND B.COUNTY_FIPS=@loctxt) FOR XML PATH ('WC:Report'));
	
END
--END COUNTY

IF @loctype='REPORTUNIT'
BEGIN
--BEGIN REPORTUNIT

WITH XMLNAMESPACES('ReplaceMe' AS WC)

SELECT @tmp=(SELECT REPORT_ID AS 'WC:ReportIdentifier',
	REPORTING_DATE AS 'WC:ReportingDate',
	REPORTING_YEAR AS 'WC:ReportingYear',
	REPORT_NAME AS 'WC:ReportName',
	REPORT_LINK AS 'WC:ReportLink',
	YEAR_TYPE AS 'WC:YearType',
	(SELECT WADE_R.LocationCatalog(@orgid, REPORT_ID, @loctype, @loctxt))
	
	FROM 
	
	WADE.REPORT A WHERE ORGANIZATION_ID=@orgid and EXISTS (SELECT B.ORGANIZATION_ID, B.REPORT_ID 
	FROM WADE_R.CATALOG_SUMMARY B WHERE A.ORGANIZATION_ID=B.ORGANIZATION_ID AND A.REPORT_ID=B.REPORT_ID 
	AND B.REPORT_UNIT_ID=@loctxt) FOR XML PATH ('WC:Report'));
	
END
--END REPORTUNIT

RETURN (@tmp)
		
END



GO


