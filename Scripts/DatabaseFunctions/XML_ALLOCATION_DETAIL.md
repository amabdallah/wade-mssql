USE [WaDE_Oct2014]
GO

/****** Object:  UserDefinedFunction [wade_r].[XML_ALLOCATION_DETAIL]    Script Date: 8/15/2016 11:33:14 AM ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO


CREATE FUNCTION [wade_r].[XML_ALLOCATION_DETAIL](@orgid varchar(10), @reportid varchar(35), @loctype varchar(max), @loctxt varchar(max),@datatype varchar(60)) 

RETURNS XML

BEGIN
--START FUNCTION

DECLARE @tmp XML;

IF @datatype<>'ALL'

BEGIN
--START NOT ALL

IF @loctype='HUC'

BEGIN
--START HUC

WITH XMLNAMESPACES ('ReplaceMe' AS WC)
	
SELECT @tmp=(SELECT ALLOCATION_ID AS 'WC:AllocationIdentifier',
	ALLOCATION_OWNER as 'WC:AllocationOwnerName',
	APPLICATION_DATE AS 'WC:ApplicationDate',
	PRIORITY_DATE AS 'WC:PriorityDate',
	END_DATE AS 'WC:EndDate',
	C.VALUE AS 'WC:LegalStatusCode',
	(SELECT WADE_R.XML_D_ALLOCATION_LOCATION (@orgid, @reportid, @loctype, @loctxt,A.ALLOCATION_ID)),
	(SELECT CASE WHEN @datatype='ALLOCATION' THEN (SELECT WADE_R.ALLOCATION_AMOUNT(@orgid, @reportid, A.ALLOCATION_ID))
	WHEN @datatype='DIVERSION' THEN (SELECT WADE_R.ALLOCATION_AMOUNT(@orgid, @reportid, A.ALLOCATION_ID), 
									(SELECT WADE_R.XML_DIVERSION_DETAIL(@orgid, @reportid, A.ALLOCATION_ID)) FOR XML PATH (''),TYPE)
	WHEN @datatype='USE' THEN (SELECT WADE_R.XML_USE_DETAIL(@orgid, @reportid, A.ALLOCATION_ID))
	WHEN @datatype='RETURN' THEN (SELECT WADE_R.XML_RETURNFLOW_DETAIL(@orgid, @reportid, A.ALLOCATION_ID))end)
	
	FROM WADE.DETAIL_ALLOCATION A LEFT JOIN WADE.LU_LEGAL_STATUS C ON (A.LEGAL_STATUS=C.LU_SEQ_NO) WHERE EXISTS (SELECT B.ALLOCATION_ID FROM WADE_R.DETAIL_LOCATION B WHERE
	A.ORGANIZATION_ID=B.ORGANIZATION_ID AND A.REPORT_ID=B.REPORT_ID AND A.ALLOCATION_ID=B.ALLOCATION_ID 
	AND B.ORGANIZATION_ID=@orgid AND B.REPORT_ID=@reportid AND B.HUC LIKE @loctxt + '%' AND B.DATATYPE=@datatype)
	
	FOR XML PATH ('WC:WaterAllocation'));

END
--END HUC	

IF @loctype='COUNTY'

BEGIN
--START COUNTY

WITH XMLNAMESPACES ('ReplaceMe' AS WC)
	
SELECT @tmp=(SELECT ALLOCATION_ID AS 'WC:AllocationIdentifier',
	ALLOCATION_OWNER as 'WC:AllocationOwnerName',
	APPLICATION_DATE AS 'WC:ApplicationDate',
	PRIORITY_DATE AS 'WC:PriorityDate',
	END_DATE AS 'WC:EndDate',
	C.VALUE AS 'WC:LegalStatusCode',
	(SELECT WADE_R.XML_D_ALLOCATION_LOCATION (@orgid, @reportid, @loctype, @loctxt,A.ALLOCATION_ID)),
	(SELECT CASE WHEN @datatype='ALLOCATION' THEN (SELECT WADE_R.ALLOCATION_AMOUNT(@orgid, @reportid, A.ALLOCATION_ID))
	WHEN @datatype='DIVERSION' THEN (SELECT WADE_R.ALLOCATION_AMOUNT(@orgid, @reportid, A.ALLOCATION_ID), 
									(SELECT WADE_R.XML_DIVERSION_DETAIL(@orgid, @reportid, A.ALLOCATION_ID)) FOR XML PATH (''),TYPE)
	WHEN @datatype='USE' THEN (SELECT WADE_R.XML_USE_DETAIL(@orgid, @reportid, A.ALLOCATION_ID))
	WHEN @datatype='RETURN' THEN (SELECT WADE_R.XML_RETURNFLOW_DETAIL(@orgid, @reportid, A.ALLOCATION_ID))end)
	
	FROM WADE.DETAIL_ALLOCATION A LEFT JOIN WADE.LU_LEGAL_STATUS C ON (A.LEGAL_STATUS=C.LU_SEQ_NO) WHERE EXISTS (SELECT B.ALLOCATION_ID FROM WADE_R.DETAIL_LOCATION B WHERE
	A.ORGANIZATION_ID=B.ORGANIZATION_ID AND A.REPORT_ID=B.REPORT_ID AND A.ALLOCATION_ID=B.ALLOCATION_ID 
	AND B.ORGANIZATION_ID=@orgid AND B.REPORT_ID=@reportid AND B.COUNTY_FIPS=@loctxt AND B.DATATYPE=@datatype)
	
	FOR XML PATH ('WC:WaterAllocation'));

END
--END COUNTY

IF @loctype='REPORTUNIT'
BEGIN
--START REPORTUNIT

WITH XMLNAMESPACES ('ReplaceMe' AS WC)

SELECT @tmp=(SELECT ALLOCATION_ID AS 'WC:AllocationIdentifier',
	ALLOCATION_OWNER AS 'WC:AllocationOwnerName', 
	APPLICATION_DATE AS 'WC:ApplicationDate',
	PRIORITY_DATE AS 'WC:PriorityDate', 
	END_DATE AS 'WC:EndDate',
	C.VALUE AS 'WC:LegalStatusCode', 
	(SELECT WADE_R.XML_D_ALLOCATION_LOCATION (@orgid, @reportid, @loctype, @loctxt,A.ALLOCATION_ID)),
	(SELECT CASE WHEN @datatype='ALLOCATION' THEN (SELECT WADE_R.ALLOCATION_AMOUNT(@orgid, @reportid, A.ALLOCATION_ID))
	WHEN @datatype='DIVERSION' THEN (SELECT WADE_R.ALLOCATION_AMOUNT(@orgid, @reportid, A.ALLOCATION_ID), 
									(SELECT WADE_R.XML_DIVERSION_DETAIL(@orgid, @reportid, A.ALLOCATION_ID)) FOR XML PATH (''),TYPE)
	WHEN @datatype='USE' THEN (SELECT WADE_R.XML_USE_DETAIL(@orgid, @reportid, A.ALLOCATION_ID))
	WHEN @datatype='RETURN' THEN (SELECT WADE_R.XML_RETURNFLOW_DETAIL(@orgid, @reportid, A.ALLOCATION_ID))end)
		
	FROM WADE.DETAIL_ALLOCATION A LEFT JOIN WADE.LU_LEGAL_STATUS C ON (A.LEGAL_STATUS=C.LU_SEQ_NO) WHERE EXISTS (SELECT B.ALLOCATION_ID FROM WADE_R.DETAIL_LOCATION B WHERE
	A.ORGANIZATION_ID=B.ORGANIZATION_ID AND A.REPORT_ID=B.REPORT_ID AND A.ALLOCATION_ID=B.ALLOCATION_ID 
	AND B.ORGANIZATION_ID=@orgid AND B.REPORT_ID=@reportid AND B.REPORTING_UNIT_ID=@loctxt AND B.DATATYPE=@datatype)
	
	FOR XML PATH ('WC:WaterAllocation'));
	
END
--END REPORT UNIT

END
--END NOT ALL PARAMETER

ELSE

BEGIN
--BEGIN 'ALL' PARAMETER

IF @loctype='HUC'

BEGIN
--START HUC

WITH XMLNAMESPACES ('ReplaceMe' AS WC)

SELECT @tmp=(SELECT ALLOCATION_ID AS 'WC:AllocationIdentifier',
	ALLOCATION_OWNER as 'WC:AllocationOwnerName',
	APPLICATION_DATE AS 'WC:ApplicationDate',
	PRIORITY_DATE AS 'WC:PriorityDate',
	END_DATE AS 'WC:EndDate',
	C.VALUE AS 'WC:LegalStatusCode',
	(SELECT WADE_R.XML_D_ALLOCATION_LOCATION(@orgid,@reportid,@loctype, @loctxt,A.ALLOCATION_ID)),
	(SELECT WADE_R.ALLOCATION_AMOUNT(@orgid, @reportid, A.ALLOCATION_ID)),
	(SELECT WADE_R.XML_DIVERSION_DETAIL(@orgid, @reportid, A.ALLOCATION_ID)),
	(SELECT WADE_R.XML_USE_DETAIL(@orgid, @reportid, A.ALLOCATION_ID)),
	(SELECT WADE_R.XML_RETURNFLOW_DETAIL(@orgid, @reportid, A.ALLOCATION_ID))
	
	FROM WADE.DETAIL_ALLOCATION A LEFT JOIN WADE.LU_LEGAL_STATUS C ON (A.LEGAL_STATUS=C.LU_SEQ_NO) WHERE EXISTS (SELECT B.ALLOCATION_ID FROM WADE_R.DETAIL_LOCATION B WHERE
	A.ORGANIZATION_ID=B.ORGANIZATION_ID AND A.REPORT_ID=B.REPORT_ID AND A.ALLOCATION_ID=B.ALLOCATION_ID 
	AND B.ORGANIZATION_ID=@orgid AND B.REPORT_ID=@reportid AND B.HUC LIKE @loctxt + '%')
	
	FOR XML PATH ('WC:WaterAllocation'));
	
END 
--END HUC

IF @loctype='COUNTY'

BEGIN
--START COUNTY

WITH XMLNAMESPACES ('ReplaceMe' AS WC)

SELECT @tmp=(SELECT ALLOCATION_ID AS 'WC:AllocationIdentifier',
	ALLOCATION_OWNER AS 'WC:AllocationOwnerName', 
	APPLICATION_DATE AS 'WC:ApplicationDate',
	PRIORITY_DATE AS 'WC:PriorityDate', 
	END_DATE AS 'WC:EndDate',
	C.VALUE AS 'WC:LegalStatusCode',
	(SELECT WADE_R.XML_D_ALLOCATION_LOCATION(@orgid,@reportid,@loctype, @loctxt,A.ALLOCATION_ID)), 
	(SELECT WADE_R.ALLOCATION_AMOUNT(@orgid, @reportid, A.ALLOCATION_ID)),
	(SELECT WADE_R.XML_DIVERSION_DETAIL(@orgid, @reportid, A.ALLOCATION_ID)),
	(SELECT WADE_R.XML_USE_DETAIL(@orgid, @reportid, A.ALLOCATION_ID)),
	(SELECT WADE_R.XML_RETURNFLOW_DETAIL(@orgid, @reportid, A.ALLOCATION_ID))
	
	FROM WADE.DETAIL_ALLOCATION A LEFT JOIN WADE.LU_LEGAL_STATUS C ON (A.LEGAL_STATUS=C.LU_SEQ_NO) WHERE EXISTS (SELECT B.ALLOCATION_ID FROM WADE_R.DETAIL_LOCATION B WHERE
	A.ORGANIZATION_ID=B.ORGANIZATION_ID AND A.REPORT_ID=B.REPORT_ID AND A.ALLOCATION_ID=B.ALLOCATION_ID 
	AND B.ORGANIZATION_ID=@orgid AND B.REPORT_ID=@reportid AND B.COUNTY_FIPS=@loctxt)
	
	FOR XML PATH ('WC:WaterAllocation'));
	
END 
--END COUNTY

IF @loctype='REPORTUNIT'

BEGIN
--START REPORT UNIT

WITH XMLNAMESPACES ('ReplaceMe' AS WC)

SELECT @tmp=(SELECT ALLOCATION_ID AS 'WC:AllocationIdentifier',
	ALLOCATION_OWNER AS 'WC:AllocationOwnerName', 
	APPLICATION_DATE AS 'WC:ApplicationDate',
	PRIORITY_DATE AS 'WC:PriorityDate', 
	END_DATE AS 'WC:EndDate',
	C.VALUE AS 'WC:LegalStatusCode', 
	(SELECT WADE_R.XML_D_ALLOCATION_LOCATION(@orgid,@reportid,@loctype, @loctxt,A.ALLOCATION_ID)),
	(SELECT WADE_R.ALLOCATION_AMOUNT(@orgid, @reportid, A.ALLOCATION_ID)),
	(SELECT WADE_R.XML_DIVERSION_DETAIL(@orgid, @reportid, A.ALLOCATION_ID)),
	(SELECT WADE_R.XML_USE_DETAIL(@orgid, @reportid, A.ALLOCATION_ID)),
	(SELECT WADE_R.XML_RETURNFLOW_DETAIL(@orgid, @reportid, A.ALLOCATION_ID))
	
	FROM WADE.DETAIL_ALLOCATION A LEFT JOIN WADE.LU_LEGAL_STATUS C ON (A.LEGAL_STATUS=C.LU_SEQ_NO) WHERE EXISTS (SELECT B.ALLOCATION_ID FROM WADE_R.DETAIL_LOCATION B WHERE
	A.ORGANIZATION_ID=B.ORGANIZATION_ID AND A.REPORT_ID=B.REPORT_ID AND A.ALLOCATION_ID=B.ALLOCATION_ID 
	AND B.ORGANIZATION_ID=@orgid AND B.REPORT_ID=@reportid AND B.REPORTING_UNIT_ID=@loctxt)
	
	FOR XML PATH ('WC:WaterAllocation'));
	
END
--END REPORT UNIT

END
--END ALL PARAMETER

BEGIN
--ADD TAG
WITH XMLNAMESPACES ('ReplaceMe' AS WC)

SELECT @tmp=(SELECT @tmp FOR XML PATH('WC:ReportDetails'));

END
--END TAG

RETURN(@tmp) 

END
--END FUNCTION
GO


