USE [WaDE_Oct2014]
GO

/****** Object:  UserDefinedFunction [wade_r].[ReportUnitSummary]    Script Date: 8/15/2016 11:32:59 AM ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO

CREATE FUNCTION [wade_r].[ReportUnitSummary](@orgid varchar(10), @reportid varchar(35), @loctype varchar(max), @loctxt varchar(max), @datatype varchar(60))
  RETURNS xml 

BEGIN
--BEGIN FUNCTION
DECLARE @tmp XML;

IF @datatype<>'ALL'	

BEGIN
--BEGIN IF NOT ALL PARAMETER
IF @loctype='HUC'
BEGIN
--BEGIN HUC
WITH XMLNAMESPACES('ReplaceMe' AS WC)
	SELECT @tmp=(SELECT REPORT_UNIT_ID AS 'WC:ReportingUnitIdentifier', 
	REPORTING_UNIT_NAME as 'WC:ReportingUnitName', 
	REPORTING_UNIT_TYPE AS 'WC:ReportingUnitTypeName', 
	B.VALUE AS 'WC:Location/WC:StateCode', 
	COUNTY_FIPS AS 'WC:Location/WC:CountyFipsCode', 
	HUC AS 'WC:Location/WC:HydrologicUnitCode',
		(SELECT CASE WHEN @datatype='AVAILABILITY' THEN (SELECT WADE_R.XML_AVAILABILITY_SUMMARY(@orgid,REPORT_ID,REPORT_UNIT_ID))
        WHEN @datatype='ALLOCATION' THEN (SELECT WADE_R.XML_ALLOCATION_SUMMARY(@orgid, REPORT_ID, REPORT_UNIT_ID))
		WHEN @datatype='USE' THEN (SELECT WADE_R.XML_USE_SUMMARY(@orgid, REPORT_ID, REPORT_UNIT_ID))
		WHEN @datatype='SUPPLY' THEN (SELECT WADE_R.XML_SUPPLY_SUMMARY(@orgid, REPORT_ID, REPORT_UNIT_ID))
		WHEN @datatype='REGULATORY' THEN (SELECT WADE_R.XML_REGULATORY_SUMMARY(@orgid, REPORT_ID, REPORT_UNIT_ID))end)
	
	FROM  
	
	WADE.REPORTING_UNIT A LEFT JOIN WADE.LU_STATE B ON (A.STATE=B.LU_SEQ_NO) WHERE EXISTS (SELECT B.REPORT_UNIT_ID FROM WADE_R.SUMMARY_LOCATION B WHERE
	A.ORGANIZATION_ID=B.ORGANIZATION_ID AND A.REPORT_ID=B.REPORT_ID AND A.REPORT_UNIT_ID=B.REPORT_UNIT_ID AND B.ORGANIZATION_ID=@orgid AND 
	B.REPORT_ID=@reportid AND B.HUC=@loctxt AND B.DATATYPE=@datatype) AND A.ORGANIZATION_ID=@orgid AND A.REPORT_ID=@reportid
	
 	FOR XML PATH(''));

END
--END HUC
IF @loctype='COUNTY'
BEGIN
--BEGIN COUNTY
WITH XMLNAMESPACES('ReplaceMe' AS WC)
	SELECT @tmp=(SELECT REPORT_UNIT_ID AS 'WC:ReportingUnitIdentifier', 
	REPORTING_UNIT_NAME as 'WC:ReportingUnitName', 
	REPORTING_UNIT_TYPE AS 'WC:ReportingUnitTypeName', 
	B.VALUE AS 'WC:Location/WC:StateCode', 
	COUNTY_FIPS AS 'WC:Location/WC:CountyFipsCode', 
	HUC AS 'WC:Location/WC:HydrologicUnitCode',
	(SELECT CASE WHEN @datatype='AVAILABILITY' THEN (SELECT WADE_R.XML_AVAILABILITY_SUMMARY(@orgid,REPORT_ID,REPORT_UNIT_ID))
    WHEN @datatype='ALLOCATION' THEN  (SELECT WADE_R.XML_ALLOCATION_SUMMARY(@orgid, REPORT_ID, REPORT_UNIT_ID))
	WHEN @datatype='USE' THEN (SELECT WADE_R.XML_USE_SUMMARY(@orgid, REPORT_ID, REPORT_UNIT_ID))
	WHEN @datatype='SUPPLY' THEN (SELECT WADE_R.XML_SUPPLY_SUMMARY(@orgid, REPORT_ID, REPORT_UNIT_ID))
	WHEN @datatype='REGULATORY' THEN (SELECT WADE_R.XML_REGULATORY_SUMMARY(@orgid, REPORT_ID, REPORT_UNIT_ID))end)
	
	FROM  
	
	WADE.REPORTING_UNIT A LEFT JOIN WADE.LU_STATE B ON (A.STATE=B.LU_SEQ_NO) WHERE EXISTS(SELECT B.REPORT_UNIT_ID FROM WADE_R.SUMMARY_LOCATION B WHERE
	A.ORGANIZATION_ID=B.ORGANIZATION_ID AND A.REPORT_ID=B.REPORT_ID AND A.REPORT_UNIT_ID=B.REPORT_UNIT_ID AND B.ORGANIZATION_ID=@orgid AND
	B.REPORT_ID=@reportid AND B.COUNTY_FIPS=@loctxt AND B.DATATYPE=@datatype) AND A.ORGANIZATION_ID=@orgid AND A.REPORT_ID=@reportid
	
 	FOR XML PATH(''));

END
--END COUNTY
IF @loctype='REPORTUNIT'
BEGIN
--BEGIN REPORTUNIT
WITH XMLNAMESPACES('ReplaceMe' AS WC)
SELECT @tmp=(SELECT REPORT_UNIT_ID AS 'WC:ReportingUnitIdentifier', 
	REPORTING_UNIT_NAME as 'WC:ReportingUnitName', 
	REPORTING_UNIT_TYPE AS 'WC:ReportingUnitTypeName', 
	B.VALUE AS 'WC:Location/WC:StateCode', 
	COUNTY_FIPS AS 'WC:Location/WC:CountyFipsCode', 
	HUC AS 'WC:Location/WC:HydrologicUnitCode',
		(SELECT CASE WHEN @datatype='AVAILABILITY' THEN (SELECT WADE_R.XML_AVAILABILITY_SUMMARY(@orgid,REPORT_ID,REPORT_UNIT_ID))
		WHEN @datatype='ALLOCATION' THEN  (SELECT WADE_R.XML_ALLOCATION_SUMMARY(@orgid, REPORT_ID, REPORT_UNIT_ID))
		WHEN @datatype='USE' THEN (SELECT WADE_R.XML_USE_SUMMARY(@orgid, REPORT_ID, REPORT_UNIT_ID))
		WHEN @datatype='SUPPLY' THEN (SELECT WADE_R.XML_SUPPLY_SUMMARY(@orgid, REPORT_ID, REPORT_UNIT_ID))
		WHEN @datatype='REGULATORY' THEN (SELECT WADE_R.XML_REGULATORY_SUMMARY(@orgid, REPORT_ID, REPORT_UNIT_ID))end)
		
	FROM
	  
	WADE.REPORTING_UNIT A LEFT JOIN WADE.LU_STATE B ON (A.STATE=B.LU_SEQ_NO) WHERE EXISTS(SELECT B.REPORT_UNIT_ID FROM WADE_R.SUMMARY_LOCATION B WHERE
	A.ORGANIZATION_ID=B.ORGANIZATION_ID AND A.REPORT_ID=B.REPORT_ID AND A.REPORT_UNIT_ID=B.REPORT_UNIT_ID AND B.ORGANIZATION_ID=@orgid AND
	B.REPORT_ID=@reportid AND B.REPORT_UNIT_ID=@loctxt AND B.DATATYPE=@datatype) AND A.ORGANIZATION_ID=@orgid AND A.REPORT_ID=@reportid
	
 	FOR XML PATH(''));

END
--END REPORTUNIT
END
--END  NOT ALL

ELSE

BEGIN
--BEGIN ALL PARAMETER

IF @loctype='HUC'

BEGIN
--BEGIN HUC

WITH XMLNAMESPACES('ReplaceMe' AS WC)
	SELECT @tmp=(SELECT REPORT_UNIT_ID AS 'WC:ReportingUnitIdentifier', 
	REPORTING_UNIT_NAME as 'WC:ReportingUnitName', 
	REPORTING_UNIT_TYPE AS 'WC:ReportingUnitTypeName', 
	B.VALUE AS 'WC:Location/WC:StateCode', 
	COUNTY_FIPS AS 'WC:Location/WC:CountyFipsCode', 
	HUC AS 'WC:Location/WC:HydrologicUnitCode',
		(SELECT WADE_R.XML_AVAILABILITY_SUMMARY(@orgid, REPORT_ID, REPORT_UNIT_ID)),
		(SELECT WADE_R.XML_ALLOCATION_SUMMARY(@orgid, REPORT_ID, REPORT_UNIT_ID)),
		(SELECT WADE_R.XML_USE_SUMMARY(@orgid, REPORT_ID, REPORT_UNIT_ID)),
		(SELECT WADE_R.XML_SUPPLY_SUMMARY(@orgid, REPORT_ID, REPORT_UNIT_ID)),
		(SELECT WADE_R.XML_REGULATORY_SUMMARY(@orgid, REPORT_ID, REPORT_UNIT_ID))
	
	FROM  
	
	WADE.REPORTING_UNIT A LEFT JOIN WADE.LU_STATE B ON (A.STATE=B.LU_SEQ_NO) WHERE EXISTS (SELECT B.REPORT_UNIT_ID FROM WADE_R.SUMMARY_LOCATION B WHERE
	A.ORGANIZATION_ID=B.ORGANIZATION_ID AND A.REPORT_ID=B.REPORT_ID	AND A.REPORT_UNIT_ID=B.REPORT_UNIT_ID AND B.ORGANIZATION_ID=@orgid 
	AND B.REPORT_ID=@reportid 
	AND B.HUC=@loctxt) AND A.ORGANIZATION_ID=@orgid 
	AND A.REPORT_ID=@reportid
	
 	FOR XML PATH(''));
 	
END
--END HUC

IF @loctype='COUNTY'
BEGIN
--BEGIN COUNTY

WITH XMLNAMESPACES('ReplaceMe' AS WC)	

SELECT @tmp=(SELECT REPORT_UNIT_ID AS 'WC:ReportingUnitIdentifier', 
	REPORTING_UNIT_NAME as 'WC:ReportingUnitName', 
	REPORTING_UNIT_TYPE AS 'WC:ReportingUnitTypeName', 
	B.VALUE AS 'WC:Location/WC:StateCode', 
	COUNTY_FIPS AS 'WC:Location/WC:CountyFipsCode', 
	HUC AS 'WC:Location/WC:HydrologicUnitCode',
	(SELECT WADE_R.XML_AVAILABILITY_SUMMARY(@orgid,REPORT_ID,REPORT_UNIT_ID)),
        (SELECT WADE_R.XML_ALLOCATION_SUMMARY(@orgid, REPORT_ID, REPORT_UNIT_ID)),
		(SELECT WADE_R.XML_USE_SUMMARY(@orgid, REPORT_ID, REPORT_UNIT_ID)),
		(SELECT WADE_R.XML_SUPPLY_SUMMARY(@orgid, REPORT_ID, REPORT_UNIT_ID)),
		(SELECT WADE_R.XML_REGULATORY_SUMMARY(@orgid, REPORT_ID, REPORT_UNIT_ID))
		
	FROM
	  
	WADE.REPORTING_UNIT A LEFT JOIN WADE.LU_STATE B ON (A.STATE=B.LU_SEQ_NO) WHERE EXISTS(SELECT B.REPORT_UNIT_ID FROM WADE_R.SUMMARY_LOCATION B WHERE
	A.ORGANIZATION_ID=B.ORGANIZATION_ID AND A.REPORT_ID=B.REPORT_ID AND A.REPORT_UNIT_ID=B.REPORT_UNIT_ID AND B.ORGANIZATION_ID=@orgid 
	AND B.REPORT_ID=@reportid 
	AND B.COUNTY_FIPS=@loctxt) AND A.ORGANIZATION_ID=@orgid 
	AND A.REPORT_ID=@reportid
	
 	FOR XML PATH(''));
 	
END
--END COUNTY

IF @loctype='REPORTUNIT'
BEGIN
--BEGIN REPORTUNIT

WITH XMLNAMESPACES('ReplaceMe' AS WC)	

SELECT @tmp=(SELECT REPORT_UNIT_ID AS 'WC:ReportingUnitIdentifier', 
	REPORTING_UNIT_NAME as 'WC:ReportingUnitName', 
	REPORTING_UNIT_TYPE AS 'WC:ReportingUnitTypeName', 
	B.VALUE AS 'WC:Location/WC:StateCode', 
	COUNTY_FIPS AS 'WC:Location/WC:CountyFipsCode', 
	HUC AS 'WC:Location/WC:HydrologicUnitCode',
		(SELECT WADE_R.XML_AVAILABILITY_SUMMARY(@orgid,REPORT_ID,REPORT_UNIT_ID)),
        (SELECT WADE_R.XML_ALLOCATION_SUMMARY(@orgid, REPORT_ID, REPORT_UNIT_ID)),
		(SELECT WADE_R.XML_USE_SUMMARY(@orgid, REPORT_ID, REPORT_UNIT_ID)),
		(SELECT WADE_R.XML_SUPPLY_SUMMARY(@orgid, REPORT_ID, REPORT_UNIT_ID)),
		(SELECT WADE_R.XML_REGULATORY_SUMMARY(@orgid, REPORT_ID, REPORT_UNIT_ID))
		
	FROM
	  
	WADE.REPORTING_UNIT A LEFT JOIN WADE.LU_STATE B ON (A.STATE=B.LU_SEQ_NO) WHERE EXISTS(SELECT B.REPORT_UNIT_ID FROM WADE_R.SUMMARY_LOCATION B WHERE
	A.ORGANIZATION_ID=B.ORGANIZATION_ID AND A.REPORT_ID=B.REPORT_ID AND A.REPORT_UNIT_ID=B.REPORT_UNIT_ID AND B.ORGANIZATION_ID=@orgid 
	AND B.REPORT_ID=@reportid 
	AND B.REPORT_UNIT_ID=@loctxt) AND A.ORGANIZATION_ID=@orgid 
	AND A.REPORT_ID=@reportid
	
 	FOR XML PATH(''));
 	
END
--END REPORTUNIT

END
--END ALL
IF @tmp IS NOT NULL
BEGIN
WITH XMLNAMESPACES ('ReplaceMe' AS WC)
SELECT @tmp = (SELECT @tmp FOR XML PATH ('WC:ReportingUnit'));
END

RETURN(@tmp)

END
--END FUNCTION

GO


